---
title: "Storing and Fine-Tuning APackOfTheClones Runs"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{APackOfTheClones-runs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
data: 'Compiled: `r format(Sys.Date(), "%B %d, %Y")`'
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

knitr::opts_chunk$set(echo = FALSE)
options(rmarkdown.html_vignette.check_title = FALSE)
options(repos = c(CRAN = "http://cran.rstudio.com"))

# utility functions
head <- function(df) {
  knitr::kable(utils::head(df))
}

quiet_load <- function(pkg, CRAN = TRUE, dev_dir = "Qile0317/") {
  if (!require(pkg, quietly = TRUE, character.only = TRUE)) {
    if (CRAN) {
      invisible(install.packages(pkg, quiet = TRUE, verbose = FALSE, character.only = TRUE))
    } else {
      suppressWarnings(suppressMessages(
        devtools::install_github(paste(dev_dir, pkg, sep = ""))
      ))
    }
  }
  suppressPackageStartupMessages(invisible(require(pkg, character.only = TRUE)))
}

quiet_load_all_CRAN <- function(...) {
  pkgs <- list(...)
  for (pkg in pkgs) {quiet_load(pkg)}
}

# load packages and data
quiet_load_all_CRAN("ggplot2", "cowplot", "Seurat", "devtools")
# TODO use a nice looking dataset
```

```{r setup}
suppressPackageStartupMessages(library(APackOfTheClones))
```

## Introduction

As demonstrated in `vignette("APackOfTheClones-primary")`, after processing the seurat & clonotype data properly with `scRepertoire`, `vizAPOTC` provides a direct way to produce the ball-packing clonal expansion visualization, though for selecr users it may be somewhat clunky, if certain parameters need to be readjusted constantly. In this vignette, more details about how APackOfTheClones runs can be stored and re-adjusted will be covered - mainly through `RunAPOTC`, `APOTCPlot`, and `AdjustAPOTC`. Ensure to read the aforementioned vignette before this one.

<details>

  <summary>
  **As a reminder, here's how to set up the seurat object and clonotype data**
  </summary>

```{r, setup_seurat, echo = TRUE}
# load in the corresponding 6-sample TCR contigs from scRepertoire
contig_list <- get(data("contig_list", package = "scRepertoire"))

# combine the TCR contigs into clones with custom samples
combined_contig_list <- scRepertoire::combineTCR(
  contig_list,
  samples = c("P17B", "P17L", "P18B", "P18L", "P19B", "P19L", "P20B", "P20L"),
  removeNA = FALSE, 
  removeMulti = FALSE, 
  filterMulti = FALSE
)

# a seurat object named `pbmc` is loaded
pbmc <- combineSeuratExpression(
  input.data = combined_contig_list,
  sc.data = pbmc,
  cloneCall = "gene",
  proportion = TRUE
)

print(pbmc)
```

</details>

### Overview

All of `vizAPOTC`'s arguments are actually derived from `RunAPOTC` and `APOTCPlot`. Approximately, The former function takes in the first half of `vizAPOTC`'s arguments until `max_repulsion_iter`, while the latter takes in the second half, with a few additional options. `RunAPOTC` is responsible for storing data of the S4 class `ApotcData` in the seurat object under a named list in `@misc$APackOfTheClones` under some character run ID, and `APOTCPlot` allows the visualization of these data objects with some customization. 

## Managing APackOfTheClones run data

The main function to store a run is `RunAPOTC`, which approximately takes in the first half of `vizAPOTC`'s arguments until `max_repulsion_iter`, 

### Utilities for Managing APackOfTheClones Runs

TODO

## APOTCPlot

TODO

## AdjustAPOTC

TODO
